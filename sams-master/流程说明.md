# 山姆会员商店自动抢购程序 - 流程说明

## 项目概述
这是一个自动化程序，模拟山姆会员商店APP的操作流程，自动完成从购物车到下单的全过程。就像你平时在APP上买东西一样，只不过现在是程序帮你自动操作。

---

## 完整流程详解（用大白话说明）

### 第一步：初始化会话（InitSession）
**作用**：就像你打开APP，程序需要先"登录"和"准备"一下

**具体做什么**：
1. 创建一个HTTP客户端，用来和山姆的服务器"说话"
2. 读取你提供的认证令牌（authToken），就像你的"身份证"
3. 获取你的所有收货地址列表，就像APP上显示"我的地址"
4. 如果没有指定地址ID，就让你手动选择一个地址
5. 确认支付方式（微信或支付宝）

**为什么重要**：没有这一步，程序就不知道你是谁，也不知道往哪里送货

---

### 第二步：保存配送地址（SaveDeliveryAddress）
**作用**：把你选中的地址"告诉"购物车系统

**具体做什么**：
- 调用API，把选中的地址ID保存到购物车
- 这样后续操作就知道商品要送到哪里

**为什么重要**：不同地址可能对应不同的门店和配送方式，必须先把地址定下来

---

### 第三步：获取可用商店（CheckStore）
**作用**：根据你的地址，找出附近哪些山姆门店可以给你送货

**具体做什么**：
1. 根据你地址的经纬度，调用API查询附近的门店
2. 获取每个门店的信息：
   - 门店ID
   - 门店名称
   - 门店类型
   - 配送模板ID（决定配送规则）
   - 区域区块ID（决定配送范围）

**为什么重要**：不同门店的商品库存、配送时间都不同，必须知道哪些门店可用

---

### 第四步：获取购物车商品（CheckCart）
**作用**：把你购物车里的商品都"拿出来看看"

**具体做什么**：
1. 调用API获取购物车详情
2. 把商品分类：
   - 正常商品（有货）
   - 缺货商品（库存不足）
   - 完全无货商品
3. 对每个商品检查：
   - 是否有库存（StockQuantity > 0）
   - 是否在售（IsPutOnSale）
   - 是否可用（IsAvailable）
   - 是否超过限购数量（LimitNum）
4. 自动调整数量：
   - 如果库存少于购物数量，就改成库存数量
   - 如果超过限购，就改成限购数量

**为什么重要**：只有知道购物车里有什么，才能继续下单

---

### 第五步：校验商品（CheckGoods）
**作用**：再次确认商品是否真的可以买

**具体做什么**：
- 调用API，让服务器再次检查商品状态
- 如果商品有异常（比如突然缺货），会返回错误信息

**为什么重要**：购物车里的商品状态可能随时变化，下单前必须再确认一次

---

### 第六步：获取结算信息（CheckSettleInfo）
**作用**：计算一下这单要花多少钱，包括运费

**具体做什么**：
1. 调用API获取结算详情
2. 获取信息包括：
   - 运费（DeliveryFee）
   - 配送方式信息
   - 配送地址信息
3. 如果设置了"免运费下单"（deliveryFee=true），但运费不是0，就重新检查购物车

**为什么重要**：必须知道总价和运费，才能决定是否继续下单

---

### 第七步：获取配送时间（GetCapacity）
**作用**：看看什么时候可以送货

**具体做什么**：
1. 调用API查询可用的配送时间段
2. 获取今天和明天的所有时间段
3. 筛选出：
   - 未约满的时间段（TimeISFull == false）
   - 未被禁用的时间段（Disabled == false）
4. 把所有可用时间段保存起来

**为什么重要**：必须选一个能送货的时间，否则无法下单

---

### 第八步：提交订单（CommitPay）
**作用**：最后一步，正式下单！

**具体做什么**：
1. 从可用时间段中选一个
2. 组装订单数据：
   - 商品列表
   - 配送地址
   - 配送时间
   - 支付方式
   - 优惠券（如果有）
3. 调用API提交订单
4. 如果成功，返回订单号
5. 如果配置了Bark通知，就发送成功通知

**为什么重要**：这是最关键的一步，成功就抢到了！

---

## 错误处理和重试机制

程序设计了完善的错误处理：

1. **限流错误**（LIMITED）：服务器太忙，等1秒再试
2. **缺货错误**（OOSErr）：商品没货了，重新检查购物车
3. **限购错误**：商品超过限购，重新检查购物车
4. **时间段失效**：选的时间段被抢完了，换下一个时间段
5. **超重错误**：极速达订单超重，减少商品数量
6. **门店关闭**：门店打烊了，重新获取门店列表

程序会在这些错误之间循环，直到成功或你手动停止。

---

## 关键数据结构

### 地址（Address）
- 地址ID、姓名、手机号
- 省市区、详细地址
- 经纬度

### 商店（Store）
- 商店ID、名称、类型
- 配送模板ID、区域区块ID

### 商品（Goods）
- 商品ID、名称、价格
- 数量、是否勾选
- 重量

### 配送时间（SettleDeliveryInfo）
- 配送时间段字符串
- 开始和结束时间戳

---

## 总结

整个流程就像你在APP上手动操作：
1. 打开APP（初始化）
2. 选地址（保存地址）
3. 看附近有哪些店（获取商店）
4. 看购物车（获取商品）
5. 确认商品还能买（校验商品）
6. 看要花多少钱（结算信息）
7. 选配送时间（获取时间段）
8. 下单付款（提交订单）

程序的优势是：**快！** 可以快速循环检查，一旦有货就立即下单，比手动操作快得多。

